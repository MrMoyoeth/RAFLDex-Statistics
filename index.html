<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAFLDex Statistics by SrMessi.eth</title>
    <!-- Add Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Link the custom CSS file -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>RAFLDex Statistics by SrMessi.eth</h1>

    <!-- Container for the chart -->
    <div class="chart-container" style="height: 400px;">
        <canvas id="buyEntryChart"></canvas>
    </div>

    <!-- Add a 3px separation -->
    <div style="height: 3px;"></div>

    <!-- Container for the Create Raffle chart -->
    <div class="chart-container" style="height: 400px;">
        <canvas id="createRaffleChart"></canvas>
    </div>

    <!-- Add a 3px separation -->
    <div style="height: 3px;"></div>

    <!-- Container for the Cancel Raffle chart -->
    <div class="chart-container" style="height: 400px;">
        <canvas id="cancelRaffleChart"></canvas>
    </div>
    <script>
        // Replace with your Etherscan API key
        const etherscanApiKey = 'XI5R9WPV2NGFQQTZ9WQZHMYTCI119GPQT5';

        // Specify the contract address
        const contractAddress = '0x08e1bc602c44ecb7932387b6792c3cb0a5c64a92';

        // Function signature of the "buyEntry" function
        const buyEntrySignature = '0xb26a78c5'; // Replace with the actual function signature

        // Function signature of the "cancelRaffle" function
        const cancelRaffleSignature = '0x5fba3171'; // Replace with the actual function signature

        // Function signatures to filter for the new chart
        const createRaffleSignatures = ['0xcf482ee9', '0x01a6e623', '0xead5c7bd'];

        // Construct the Etherscan API URL to fetch transactions
        const apiUrl = `https://api.etherscan.io/api?module=account&action=txlist&address=${contractAddress}&apikey=${etherscanApiKey}`;

        // Fetch data from the Etherscan API
        fetch(apiUrl)
            .then((response) => response.json())
            .then((data) => {
                const transactions = data.result;

                // Calculate the offset between local timezone and Etherscan's timezone
                const localTimezoneOffset = new Date().getTimezoneOffset(); // Offset in minutes
                const etherscanTimezoneOffset = 0; // Adjust this offset if needed
                
                // Function to convert Unix timestamps to the Etherscan timezone
                function convertToEtherscanTimezone(timestamp) {
                    return new Date((timestamp * 1000) + ((localTimezoneOffset - etherscanTimezoneOffset) * 60 * 1000));
                }

                // Process transactions and group by day for BuyEntry chart
                const buyEntryTransactionsByDay = {};
                transactions.forEach((transaction) => {
                    const timestamp = convertToEtherscanTimezone(parseInt(transaction.timeStamp));
                    const day = `${timestamp.getFullYear()}-${(timestamp.getMonth() + 1).toString().padStart(2, '0')}-${timestamp.getDate().toString().padStart(2, '0')}`;

                    if (transaction.input.startsWith(buyEntrySignature)) {
                        if (buyEntryTransactionsByDay[day]) {
                            buyEntryTransactionsByDay[day]++;
                        } else {
                            buyEntryTransactionsByDay[day] = 1;
                        }
                    }
                });

                // Process transactions and group by day for CancelRaffle chart
                const cancelRaffleTransactionsByDay = {};
                transactions.forEach((transaction) => {
                    const timestamp = convertToEtherscanTimezone(parseInt(transaction.timeStamp));
                    const day = `${timestamp.getFullYear()}-${(timestamp.getMonth() + 1).toString().padStart(2, '0')}-${timestamp.getDate().toString().padStart(2, '0')}`;

                    if (transaction.input.startsWith(cancelRaffleSignature)) {
                        if (cancelRaffleTransactionsByDay[day]) {
                            cancelRaffleTransactionsByDay[day]++;
                        } else {
                            cancelRaffleTransactionsByDay[day] = 1;
                        }
                    }
                });

                // Process transactions and group by day for CreateRaffle chart
                const createRaffleTransactionsByDay = {};
                transactions.forEach((transaction) => {
                    const timestamp = convertToEtherscanTimezone(parseInt(transaction.timeStamp));
                    const day = `${timestamp.getFullYear()}-${(timestamp.getMonth() + 1).toString().padStart(2, '0')}-${timestamp.getDate().toString().padStart(2, '0')}`;

                    if (createRaffleSignatures.some((signature) => transaction.input.includes(signature))) {
                        if (createRaffleTransactionsByDay[day]) {
                            createRaffleTransactionsByDay[day]++;
                        } else {
                            createRaffleTransactionsByDay[day] = 1;
                        }
                    }
                });

                // Convert data to arrays for each chart
                const buyEntryLabels = Object.keys(buyEntryTransactionsByDay);
                const buyEntryDataValues = buyEntryLabels.map((day) => buyEntryTransactionsByDay[day] || 0);

                const cancelRaffleLabels = Object.keys(cancelRaffleTransactionsByDay);
                const cancelRaffleDataValues = cancelRaffleLabels.map((day) => cancelRaffleTransactionsByDay[day] || 0);

                const createRaffleLabels = Object.keys(createRaffleTransactionsByDay);
                const createRaffleDataValues = createRaffleLabels.map((day) => createRaffleTransactionsByDay[day] || 0);

                // Create BuyEntry Chart
                const buyEntryCtx = document.getElementById('buyEntryChart').getContext('2d');
                new Chart(buyEntryCtx, {
                    type: 'bar',
                    data: {
                        labels: buyEntryLabels,
                        datasets: [{
                            label: 'BuyEntry Transactions per Day',
                            data: buyEntryDataValues,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'category',
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Transactions'
                                }
                            }
                        }
                    }
                });

                // Create CreateRaffle Chart
                const createRaffleCtx = document.getElementById('createRaffleChart').getContext('2d');
                new Chart(createRaffleCtx, {
                    type: 'bar',
                    data: {
                        labels: createRaffleLabels,
                        datasets: [{
                            label: 'CreateRaffle Transactions per Day',
                            data: createRaffleDataValues,
                            backgroundColor: 'rgba(192, 75, 192, 0.2)',
                            borderColor: 'rgba(192, 75, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'category',
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Transactions'
                                }
                            }
                        }
                    }
                });

                // Create CancelRaffle Chart
                const cancelRaffleCtx = document.getElementById('cancelRaffleChart').getContext('2d');
                new Chart(cancelRaffleCtx, {
                    type: 'bar',
                    data: {
                        labels: cancelRaffleLabels,
                        datasets: [{
                            label: 'CancelRaffle Transactions per Day',
                            data: cancelRaffleDataValues,
                            backgroundColor: 'rgba(192, 192, 75, 0.2)',
                            borderColor: 'rgba(192, 192, 75, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'category',
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Transactions'
                                }
                            }
                        }
                    }
                });
            })
            .catch((error) => {
                console.error('Error fetching data:', error);
            });
    </script>
</body>
</html>
